<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.js"
            integrity="sha256-UgvvN8vBkgO0luPSUl2s8TIlOSYRoGFAX4jlCIm9Adc=" crossorigin="anonymous"></script>
    <title>Document</title>
    <link rel="stylesheet" href="../../css/format.css"/>
    <link rel="stylesheet" href="../../css/students.css"/>
    <link rel="stylesheet" href="../../css/scholarships.css" />
    <link rel="stylesheet" href="../../css/attendances.css" />
</head>
<body id="content-wrapper">
<div th:insert="~{common/header :: header}"></div>
<div th:insert="~{common/title :: title ('출결 입력')}"></div>
<section id="attendance-contents" style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
    <article class="attendance-search-btn-wrapper">
        <div class="attendance-search-form-wrapper" style="margin-left: 30%; width: auto;">
            <div id="search-form">
                <input type="date" required class="input-date" name="attendanceDate" style="width: 130px; height: 41px; border: none; border: 1px solid #d3d3d3; border-radius: 10px; padding: 0 10px;" />
                <input placeholder="기수" id="input-course-number" class="courseId-filter" name="courseNumber"/>
                <input placeholder="수강생을 입력하세요" id="input-name" class="search-input" name="name"/>
                <button type="button" class="filter-search-btn">검색</button>
            </div>
        </div>
    </article>
    <section id="content-section">
        <article id="attendance-content-article">
            <div class="attendance-status-wrapper">
                <label><input type="radio" class="attendance-status-btn" name="attendanceStatus" value="출석">출석</label>
                <label><input type="radio" class="attendance-status-btn" name="attendanceStatus" value="결석">결석</label>
                <label><input type="radio" class="attendance-status-btn" name="attendanceStatus" value="지각">지각</label>
                <label><input type="radio" class="attendance-status-btn" name="attendanceStatus" value="외출">외출</label>
                <label><input type="radio" class="attendance-status-btn" name="attendanceStatus" value="조퇴">조퇴</label>
                <label><input type="radio" class="attendance-status-btn" name="attendanceStatus" value="출석 인정">출석 인정</label>
                <button id="combine-update-btn">선택 내용 출결 처리</button>
            </div>

            <div class="student-cnt-pages">
            </div>
        </article>
        <article>
            <table class="board-table">
                <!--
                <tr>
                    <th><input type="checkbox" /></th>
                    <th>기수</th>
                    <th>HRD-Net ID</th>
                    <th>이름</th>
                    <th>강의장</th>
                    <th>출결 상태</th>
                    <th>증빙 서류</th>
                </tr>
                <div id="table-row-wrapper">
                    <tr class="board-table-row">
                        <td class="board-checkbox"><input type="checkbox"/></td>
                        <td class="course-number">1</td>
                        <td class="hrd-net-id">2</td>
                        <td class="student-name">3</td>
                        <td class="academy-location">4</td>
                        <td class="attendance-status">
                            <select name="attendance-status-select" id="attendance-status-select">
                                <option value="">&#45;&#45;&#45;&#45;&#45;&#45;</option>
                                <option value="attendance">출석</option>
                                <option value="lateness">지각</option>
                                <option value="absence">결석</option>
                                <option value="earlyLeave">조퇴</option>
                                <option value="goOut">외출</option>
                                <option value="acknowledge">출석 인정</option>
                            </select>
                        </td>
                        <td class="evidentiary-documents">
                            <input type="file" class="file-upload-btn"/>
                        </td>
                    </tr>
                    <tr class="board-table-row">
                        <td class="board-checkbox"><input type="checkbox"/></td>
                        <td class="course-number">1</td>
                        <td class="hrd-net-id">2</td>
                        <td class="student-name">3</td>
                        <td class="academy-location">4</td>
                        <td class="attendance-status">
                            <select name="attendance-status-select" id="attendance-status-select">
                                <option value="">&#45;&#45;&#45;&#45;&#45;&#45;</option>
                                <option value="attendance">출석</option>
                                <option value="lateness">지각</option>
                                <option value="absence">결석</option>
                                <option value="earlyLeave">조퇴</option>
                                <option value="goOut">외출</option>
                                <option value="acknowledge">출석 인정</option>
                            </select>
                        </td>
                        <td class="evidentiary-documents">
                            <input type="file" class="file-upload-btn"/>
                        </td>
                    </tr>
                </div>-->
            </table>
        </article>
        <div class="update-btn-div">
            <button id="update-btn">저장</button>
        </div>
    </section>
    <article class="page-information">
        <ul id="pagination" style="margin-top: 35px;">
            <li>
                <a class="page-link" id="prev">이전</a>
            </li>
            <li id="page-number" class="page-item" style="display: flex; gap: 20px"></li>
            <li class="page-item">
                <a id="next" class="page-link">다음</a>
            </li>
        </ul>
    </article>
</section>
<footer></footer>

<script>
    let totalPage = 0;
    let currentPage = 1;
    let currentBlock = 1;
    const pageSize = 10;
    // const page = new URL(location.href).search.split("=")[0];
    const page = 1;

    function getCourseNumber() {
        if($("#input-course-number").val() == "") {
            return -1;
        }
        return parseInt($(".courseId-filter").val());
    }

    function getStudentName() {
        // return $(".search-input").val();
        if($(".search-input").val() == "") {
            return "none";
        }
        return $(".search-input").val();
    }

    function getAttendanceDate() {
        return $(".input-date").val();
    }

    // 검색한 출결 상태 목록 데이터 화면에 보여주기
    async function getAttendanceList(data) {
        // let result = '';
        let result = `<tr>
                    <th><input type="checkbox" /></th>
                    <th>기수</th>
                    <th>HRD-Net ID</th>
                    <th>이름</th>
                    <th>강의장</th>
                    <th>출결 상태</th>
                    <th>증빙 서류</th>
                </tr>`;
        for(let i=0; i<data.length; i++) {
            let attendanceCheck = "";
            let latenessCheck = "";
            let absenceCheck = "";
            let earlyLeaveCheck = "";
            let goOutCheck = "";
            let acknowledgeCheck = "";
            let defaultCheck = "";

            switch(data[i].attendanceStatus) {
                case "출석":
                    attendanceCheck = "selected";
                    break;
                case "지각":
                    latenessCheck = "selected";
                    break;
                case "결석":
                    absenceCheck = "selected";
                    break;
                case "조퇴":
                    earlyLeaveCheck = "selected";
                    break;
                case "외출":
                    goOutCheck = "selected";
                    break;
                case "출석 인정":
                    acknowledgeCheck = "selected";
                    break;
                default:
                    defaultCheck = "selected";
            }

            result += `<tr class="board-table-row">
                    <td class="board-checkbox"><input type="checkbox"/></td>
                    <td class="course-number">${data[i].courseNumber}</td>
                    <td class="hrd-net-id">${data[i].hrdNetId}</td>
                    <td class="student-name">${data[i].name}</td>
                    <td class="academy-location">${data[i].academyLocation}</td>
                    <td class="attendance-status">
                        <select name="attendance-status-select" id="attendance-status-select">
                            <option value="" ${defaultCheck}>------</option>
                            <option value="attendance" ${attendanceCheck}>출석</option>
                            <option value="lateness" ${latenessCheck}>지각</option>
                            <option value="absence" ${absenceCheck}>결석</option>
                            <option value="earlyLeave" ${earlyLeaveCheck}>조퇴</option>
                            <option value="goOut" ${goOutCheck}>외출</option>
                            <option value="acknowledge" ${acknowledgeCheck}>출석 인정</option>
                        </select>
                    </td>
                    <td class="evidentiary-documents">
                        <input type="file" class="file-upload-btn"/>
                    </td>
                </tr>`;
        }
        $(".board-table").html("");
        $(".board-table").append(result);
        // $("#table-row-wrapper").html("");
        // $("#table-row-wrapper").append(result);
        // $(".board-table").append(result);
    };

    // 검색한 출결 상태 목록 데이터 전체 개수 가져오기
    async function getAmountAttendanceList(data) {
        totalPage = Math.ceil(data/10);

        let result = '';
        result += `<span class="span-attendance-list-amount">총 ${data}건</span>`;
        $(".student-cnt-pages").html("");
        $(".student-cnt-pages").append(result);

        await updatePagination();
    }

    // 검색한 출결 상태 목록 데이터 가져오기
    async function fetchAttendanceList(param) {
        const myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json");

        const raw = JSON.stringify({
            "name": getStudentName(),
            "courseNumber": getCourseNumber(),
            "attendanceDate": getAttendanceDate()
        });

        const requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: raw,
            redirect: "follow"
        };

        await fetch("/attendances/search-list?page="+param, requestOptions)
            .then((res) => res.json())
            .then(async(data) => {
                let attendanceList = data.attendanceList;
                let amount = data.amount;

                await getAttendanceList(attendanceList);
                await getAmountAttendanceList(amount);

            })
            .catch((error) => console.error(error));
    };

    $(".filter-search-btn").click(async function() {
        const myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json");

        const raw = JSON.stringify({
            "name": getStudentName(),
            "courseNumber": getCourseNumber(),
            "attendanceDate": getAttendanceDate()
        });

        const requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: raw,
            redirect: "follow"
        };

        await fetchAttendanceList(page);
    });

    // 페이지네이션
    function updatePagination() {
        $("#page-number").html("");
        let firstPage = (currentBlock * pageSize) - pageSize + 1;
        let lastPage = totalPage <= currentBlock * pageSize ? totalPage : currentBlock * pageSize;

        for(let i = firstPage; i<= lastPage; i++) {
            let num = i;
            /* <a>태그를 <li>태그로 감싸주는 걸로 맞추기 - ~코드 일관성 */
            $("#page-number").append(`<a class="page-link" onclick="fetchStudentAttendanceList(${num})">${num}</a>`);
        }
    }

    $("#next").click(() => {
        if(currentBlock * pageSize < totalPage) {
            currentBlock ++;
            currentPage = (currentBlock * pageSize) - pageSize + 1;
            updatePagination();
        }
    });

    $("#prev").click(() => {
        if(currentBlock > 1) {
            currentBlock --;
            currentPage = (currentBlock * pageSize) - pageSize + 1;
            updatePagination();
        }
    });
</script>
</body>
</html>
