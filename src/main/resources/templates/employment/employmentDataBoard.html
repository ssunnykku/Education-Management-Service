<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.js"
            integrity="sha256-UgvvN8vBkgO0luPSUl2s8TIlOSYRoGFAX4jlCIm9Adc=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.14.3/xlsx.full.min.js"></script>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <title>Document</title>
    <link rel="stylesheet" href="../../css/format.css"/>
    <link rel="stylesheet" href="../../css/employment.css"/> 
</head>
<body id="content-wrapper">
<div th:insert="~{common/header :: header}"></div>
<div th:insert="~{common/title :: title ('KOSTA 취업률 그래프')}"></div>
<section id="employment-contents">
    <article id="employment-search-btn-wrapper">
        <div class="search-form-wrapper">
            <select name="employment-year-filter"
                    class="employment-year-filter">
                <option value="course-year" id="course-year">년도</option>
            </select>
            </div>
    </article>
    <div class="main">
    <div class="chart-container" >
        <canvas id="employment-graph"></canvas>
    </div>
    </div>  
</section>
<footer></footer>
<script>
$(".employment-year-filter").on("change", async function () {
  const courseEndYear = $(this).val();

  const response = await fetch("/courses/course-list-by-year?courseEndYear=" + courseEndYear, {
    method: "GET"
  });
  const data = await response.json();

  const courseNumberLabels = data.result.map(courseNumber => courseNumber.toString());
  chart.data.labels = courseNumberLabels;

  const courseNumbers = [];
  const courseData = [];

  for (const courseNumber of data.result) {
    const employmentDataResponse = await fetch(`/employments/avg-rate?courseNumber=${courseNumber}`);
    const employmentData = await employmentDataResponse.json();
    const courseEmploymentRate = employmentData.result;

    courseNumbers.push(courseNumber);
    courseData.push(courseEmploymentRate);
  }

  chart.data.labels = courseNumbers;
  chart.data.datasets[0].data = courseData;

  chart.update();
});

var ctx = document.getElementById('employment-graph').getContext('2d');
var chart = new Chart(ctx, {
  type: 'bar',
  data: {
    labels: [],
    datasets: [{
      label: '기수별 취업률',
      backgroundColor: '#5C7CFA',
      data: []
    }]
  },
  options: {
    legend: {
      labels: {
        fontColor: '#000000',
        fontSize: 15
      }
    },
    scales: {
      xAxes: [{
        ticks: {
          fontColor: '#000000',
          fontSize: 15
        },
        gridLines: {
          display: true // Always show Y-axis grid lines
        },
        title: { // Add X-axis title
          display: true,
          text: '기수', // Set the X-axis title text
          fontColor: '#000000',
          fontSize: 15
        }
      }],
      yAxes: [{
        ticks: {
          beginAtZero: true,
          max: 100,
          fontColor: '#000000',
          fontSize: 15
        },
        gridLines: {
          display: true // Always show Y-axis grid lines
        },
        title: { // Add Y-axis title
          display: true,
          text: '취업률 (%)', // Set the Y-axis title text
          fontColor: '#000000',
          fontSize: 15,
          align: 'center'
        }
      }],
      tooltips: {
        mode: 'index',
        intersect: false,
        callbacks: {
          tooltip_item: function(tooltipItem, data) {
            const courseNumber = data.labels[tooltipItem.index];  // Get course number from label
            const totalStudents = data.datasets[0].data[tooltipItem.index];  // Get total students
            const employed = data.datasets[1] ? data.datasets[1].data[tooltipItem.index] : 0;  // Get employed count (assuming 2nd dataset is for employed)
            const unemployed = totalStudents - employed;  // Calculate unemployed count
            const employmentRate = (employed / totalStudents * 100).toFixed(1);  // Calculate employment rate

            // Create HTML content for tooltip
            const html = `
              ${courseNumber}기<br>
              총 학생: ${totalStudents}명<br>
              취업: ${employed}명<br>
              미취업: ${unemployed}명<br>
              취업률: ${employmentRate}%`;

            return html;
          }
        }
      }
    }
  }
});
</script>
</body>
<script type="text/javascript" th:src="@{/scripts/employmentBoard.js}"></script>
</html>
