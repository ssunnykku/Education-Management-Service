<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.js"
            integrity="sha256-UgvvN8vBkgO0luPSUl2s8TIlOSYRoGFAX4jlCIm9Adc=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.14.3/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <title>Document</title>
    <link rel="stylesheet" href="../../css/format.css"/>
    <link rel="stylesheet" href="../../css/employment.css"/> 
</head>
<body id="content-wrapper">
<div th:insert="~{common/header :: header}"></div>
<div th:insert="~{common/title :: title ('KOSTA 취업률 그래프')}"></div>
<section id="employment-contents">
    <article id="employment-search-btn-wrapper">
        <div class="search-form-wrapper">
            <select name="employment-year-filter"
                    class="employment-year-filter">
                <option value="course-year" id="course-year">년도</option>
            </select>
            </div>
    </article>
    <div class="main">
    <div class="chart-container" >
        <canvas id="employment-graph"></canvas>
    </div>
    </div>  
</section>
<footer></footer>
<script>
	$(".employment-year-filter").on("change", async function () {
  const courseEndYear = $(this).val(); 

  const response = await fetch("/courses/course-list-by-year?courseEndYear=" + courseEndYear, {
    method: "GET" 
  });
  const data = await response.json();

  // Data processing for X-axis labels (assuming data.result is an array of years)
  const courseNumberLabels = data.result.map(courseNumber => courseNumber.toString()); // Convert numbers to strings

  // Update chart labels for X-axis
  chart.data.labels = courseNumberLabels;

  // Initialize empty arrays to store X-axis and Y-axis data
  const courseNumbers = [];
  const courseData = [];

  // Loop through each courseNumber to fetch and process additional data
  for (const courseNumber of data.result) {
    // Asynchronous fetch for employment rate
    const employmentDataResponse = await fetch(`/employments/avg-rate?courseNumber=${courseNumber}`);
    const employmentData = await employmentDataResponse.json();

    // Assuming 'employmentData' contains the employment rate (e.g., 'result')
    const courseEmploymentRate = employmentData.result; // Modify based on your data structure

    // Add courseNumber and employment rate to the respective arrays
    courseNumbers.push(courseNumber);
    courseData.push(courseEmploymentRate);
  }

  // Update chart datasets (X-axis and Y-axis data)
  chart.data.labels = courseNumbers;
  chart.data.datasets[0].data = courseData;

  // Update chart (optional for some Chart.js versions)
  chart.update();
});


    var ctx = document.getElementById('employment-graph').getContext('2d');
    var chart = new Chart(ctx, {
      // 생성하려는 차트 유형
      type: 'bar',

      // 데이터셋 데이터
      data: {
        labels: [], // 초기 X축 레이블 (빈 배열)
        datasets: [{
          label: '기수별 취업률',
          backgroundColor: ['5C7CFA'],
          data: [] // 초기 데이터 (빈 배열)
        }]
      },

  // Configuration options go here
  options: {
    legend: {
      labels: {
        fontColor: '000000',
        fontSize: 15
      }
    },
    scales: {
      xAxes: [{
        ticks: {
          fontColor: '000000',
          fontSize: '15'
        }
      }],
      
      yAxes: [{
  ticks: {
    beginAtZero: true,
    max: 100,
    fontColor: '000000',
    fontSize: '15'
  },
  gridLines: {
    display: false
  }
}]
    }
  }
});
</script>
</body>
<script type="text/javascript" th:src="@{/scripts/employmentBoard.js}"></script>
</html>
